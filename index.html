<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GTFS ‚Äî Least Worst Frequency</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220;
    --bgGradient:radial-gradient(1400px 700px at 8% -10%,#101a30 0%,#0b1220 45%,#070d18 100%);
    --panel:#111827;
    --card:#0f172a;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:#1f2937;
    --chip:#1f2937;
    --chipText:#cbd5e1;
    --accent:#60a5fa;
    --btn:#2563eb;
    --btnText:#fff;
    --inputBg:#0b1220;
    --tableStripe:rgba(255,255,255,.03);
    --bannerBg:rgba(37,99,235,.14);
    --highlight:rgba(96,165,250,.18);
    --modalOverlay:rgba(0,0,0,.65);
    --good:#10b981;
    --ok:#22c55e;
    --mid:#06b6d4;
    --warn:#f59e0b;
    --meh:#ef4444;
    --neutral:#6b7280;
  }
  body[data-theme="light"]{
    --bg:#f5f7fb;
    --bgGradient:radial-gradient(1400px 700px at 8% -10%,#ffffff 0%,#eef2ff 45%,#e2e8f0 100%);
    --panel:#ffffff;
    --card:#f1f5f9;
    --text:#1f2937;
    --muted:#4b5563;
    --line:#d1d5db;
    --chip:#e5e7eb;
    --chipText:#1f2937;
    --accent:#2563eb;
    --btn:#2563eb;
    --btnText:#fff;
    --inputBg:#f8fafc;
    --tableStripe:rgba(148,163,184,.1);
    --bannerBg:rgba(37,99,235,.18);
    --highlight:rgba(59,130,246,.25);
    --modalOverlay:rgba(15,23,42,.35);
  }
  *{box-sizing:border-box}
  body{
    font-family:"Inter",ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    margin:0;
    min-height:100vh;
    padding:24px;
    background:var(--bgGradient);
    color:var(--text);
    transition:background .3s ease,color .3s ease;
  }
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:20px}
  h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.02em}
  .headerActions{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .themeToggle{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  .themeToggle span{font-weight:700;text-transform:uppercase;letter-spacing:.05em}
  .themeButtons{display:flex;border-radius:12px;overflow:hidden}
  .themeButtons button{background:transparent;border:0;color:var(--muted);padding:6px 10px;font-weight:700;cursor:pointer;transition:background .2s ease,color .2s ease}
  .themeButtons button.active{background:var(--btn);color:var(--btnText)}
  .badge{background:var(--card);border:1px solid var(--line);color:var(--chipText);padding:8px 12px;border-radius:999px;font-size:12px;font-weight:700}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:16px;margin-bottom:18px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .controls .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;align-items:end}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
  input[type="file"],input[type="time"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--inputBg);color:var(--text)}
  input[type="file"]::-webkit-file-upload-button{display:none}
  input[type="file"]::file-selector-button{display:none}
  .fileName{font-size:12px;color:var(--muted);word-break:break-word;margin-top:4px}
  .field.action{align-items:flex-end}
  .btn{background:var(--btn);color:var(--btnText);border:0;border-radius:10px;padding:11px 18px;font-weight:800;cursor:pointer;transition:transform .2s ease,opacity .2s ease}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .toolbar{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px;align-items:center}
  .seg{display:flex;gap:6px;background:var(--card);border:1px solid var(--line);padding:4px;border-radius:12px}
  .seg button{background:transparent;border:0;color:var(--muted);padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer}
  .seg button.active{background:var(--btn);color:var(--btnText)}
  .switch{display:flex;gap:8px;align-items:center;font-weight:700;color:var(--muted)}
  .switch input{accent-color:var(--accent)}
  .search{flex:1;display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--line);padding:8px 10px;border-radius:10px}
  .search input{flex:1;background:transparent;border:0;color:var(--text);outline:none}
  .banner{display:none}
  .bannerHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  .bannerHeader h2{margin:0;font-size:16px;font-weight:800}
  .bannerHeader .hint{color:var(--muted);font-size:12px}
  .bannerBody{background:var(--bannerBg);border-radius:12px;padding:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .bannerEmpty{color:var(--muted);font-size:13px}
  .bannerPills{display:flex;flex-wrap:wrap;gap:8px}
  .bannerPills button{background:var(--btn);color:var(--btnText);border:0;border-radius:999px;padding:6px 12px;font-weight:700;font-size:13px;cursor:pointer;transition:opacity .2s ease}
  .bannerPills button:hover{opacity:.85}
  .kanban{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
  .col{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;min-height:120px}
  .col h3{margin:0 0 6px;font-size:12px;letter-spacing:.05em;color:var(--muted);text-transform:uppercase}
  .cards{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:8px 10px;cursor:pointer;transition:border-color .2s ease,transform .2s ease}
  .card:hover{border-color:var(--accent);transform:translateY(-1px)}
  .routeLine{display:flex;align-items:center;gap:6px;font-weight:800}
  .day{font-size:11px;color:var(--muted)}
  .dir{font-size:11px;background:var(--inputBg);border:1px solid var(--line);color:var(--chipText);padding:2px 6px;border-radius:999px}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
  thead th{position:sticky;top:0;background:var(--panel);backdrop-filter:blur(6px);z-index:3;color:var(--muted);text-transform:uppercase;font-size:11px;letter-spacing:.05em}
  th,td{border-bottom:1px solid var(--line);padding:10px 12px;text-align:center}
  tbody tr:nth-child(odd){background:var(--tableStripe)}
  td.route,th.route{text-align:left;position:sticky;left:0;background:var(--panel);z-index:2}
  tbody tr:nth-child(odd) td.route{background:var(--tableStripe)}
  tbody tr{scroll-margin-top:100px}
  .tier{font-weight:900;padding:6px 10px;border-radius:999px;display:inline-block;min-width:64px;cursor:help}
  .t10{background:rgba(16,185,129,.16);color:var(--good);border:1px solid rgba(16,185,129,.35)}
  .t15{background:rgba(34,197,94,.16);color:var(--ok);border:1px solid rgba(34,197,94,.35)}
  .t20{background:rgba(6,182,212,.16);color:var(--mid);border:1px solid rgba(6,182,212,.35)}
  .t30{background:rgba(245,158,11,.16);color:var(--warn);border:1px solid rgba(245,158,11,.35)}
  .t60{background:rgba(239,68,68,.16);color:var(--meh);border:1px solid rgba(239,68,68,.35)}
  .tBig{background:rgba(107,114,128,.16);color:var(--neutral);border:1px solid rgba(107,114,128,.35)}
  .badge{display:inline-flex;align-items:center;gap:6px}
  .export{margin-left:auto}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--modalOverlay);z-index:100}
  .dialog{background:var(--panel);border:1px solid var(--line);border-radius:16px;width:min(760px,94vw);max-height:92vh;padding:20px;overflow:auto}
  .dialog h3{margin:0 0 12px}
  .close{float:right;background:var(--chip);border:1px solid var(--line);color:var(--chipText);border-radius:8px;padding:6px 10px;cursor:pointer}
  .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
  .metricCard{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .metricLabel{display:block;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;font-weight:700;margin-bottom:4px}
  .metricValue{font-size:20px;font-weight:800}
  .metricSub{font-size:12px;color:var(--muted);margin-top:6px}
  .gapList{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
  .gapList .chip{background:var(--card)}
  .departuresSection{margin-bottom:16px}
  .departuresSection h4{margin:0 0 10px;font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
  .gapTables{display:grid;gap:12px}
  .gapTables.twoCols{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .gapTables.stack{grid-template-columns:1fr}
  .gapTableWrap{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
  .gapTableWrap h5{margin:0;font-size:13px;font-weight:700}
  .gapTableScroll{max-height:300px;overflow:auto;border-radius:8px;border:1px solid var(--line)}
  .gapTable{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
  .gapTable th,.gapTable td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
  .gapTable thead th{background:var(--panel);color:var(--muted);text-transform:uppercase;letter-spacing:.05em;font-size:11px;position:sticky;top:0;z-index:1}
  .gapTable tbody tr:nth-child(odd){background:var(--tableStripe)}
  .gapTable tbody tr:last-child td{border-bottom:none}
  .gapTable td.numCol{width:44px}
  .gapBadge{display:inline-block;min-width:44px;padding:4px 8px;border-radius:6px;text-align:center;font-variant-numeric:tabular-nums;border:1px solid transparent}
  .gapWarn{box-shadow:inset 0 0 0 1px var(--warn);color:var(--warn);background:rgba(245,158,11,.1)}
  .gapHigh{background:rgba(239,68,68,.2);color:var(--meh);box-shadow:inset 0 0 0 1px rgba(239,68,68,.4);font-weight:700}
  .modalBuckets{width:100%;border-collapse:separate;border-spacing:0;margin-bottom:0}
  .modalBuckets th,.modalBuckets td{text-align:left;padding:6px 8px;border-bottom:1px solid var(--line);font-size:13px}
  .modalBuckets th{color:var(--muted);text-transform:uppercase;letter-spacing:.05em;font-size:11px}
  .muted{color:var(--muted)}
  @media(max-width:900px){
    body{padding:18px}
    .kanban{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  }
  @media(max-width:600px){
    .controls .grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    header{margin-bottom:16px}
    .themeToggle{width:100%;justify-content:space-between}
    .toolbar{flex-direction:column;align-items:stretch}
    .search{width:100%}
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <h1>GTFS ‚Äî Least Worst Frequency</h1>
      <div class="headerActions">
        <div class="themeToggle" role="group" aria-label="Theme">
          <span>Theme</span>
          <div class="themeButtons">
            <button type="button" data-theme-choice="dark" class="active">Dark</button>
            <button type="button" data-theme-choice="light">Light</button>
          </div>
        </div>
        <span class="badge">Strict +2 min grace ¬∑ max 2 events</span>
      </div>
    </header>

    <section class="panel controls">
      <div class="grid">
        <div class="field">
          <label for="gtfs">GTFS ZIP</label>
          <input type="file" id="gtfs" accept=".zip">
          <div class="fileName" id="fileName">No file selected</div>
        </div>
        <div class="field">
          <label for="start">Start time</label>
          <input type="time" id="start" value="07:00">
        </div>
        <div class="field">
          <label for="end">End time</label>
          <input type="time" id="end" value="22:00">
        </div>
        <div class="field action">
          <label>&nbsp;</label>
          <button class="btn" id="go" type="button" disabled>Analyze</button>
        </div>
      </div>
      <div class="toolbar">
        <div class="seg" role="group" aria-label="Day filter">
          <button type="button" data-day="weekday" class="active">Weekday</button>
          <button type="button" data-day="saturday">Saturday</button>
          <button type="button" data-day="sunday">Sunday</button>
        </div>
        <label class="switch"><input type="checkbox" id="merge" checked> Merge directions per route</label>
        <div class="search">
          <span>üîç</span>
          <input type="search" id="search" placeholder="Search routes‚Ä¶">
        </div>
        <button class="btn export" id="export" type="button" disabled>Export CSV</button>
      </div>
    </section>

    <section class="panel banner" id="banner">
      <div class="bannerHeader">
        <h2>Weekday ‚â§15 min (07:00‚Äì22:00)</h2>
        <span class="hint">Strict +2 min grace ¬∑ max 2 events</span>
      </div>
      <div class="bannerBody">
        <div class="bannerEmpty" id="bannerEmpty">Run an analysis to see frequent routes.</div>
        <div class="bannerPills" id="bannerPills"></div>
      </div>
    </section>

    <section class="panel">
      <div class="kanban" id="kanban"></div>
    </section>

    <section class="panel">
      <table>
        <thead>
          <tr>
            <th class="route">Route</th>
            <th>Direction</th>
            <th>Day</th>
            <th>Trips</th>
            <th>Median</th>
            <th>Mode</th>
            <th>Average</th>
            <th>Tier</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </section>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dialog">
      <button class="close" type="button" id="closeModal">Close</button>
      <h3 id="modalTitle"></h3>
      <p id="modalSummary" class="muted"></p>
      <div class="metrics">
        <div class="metricCard">
          <span class="metricLabel">Median headway</span>
          <span class="metricValue" id="metricMedian">‚Äî</span>
        </div>
        <div class="metricCard">
          <span class="metricLabel">Most common headway</span>
          <span class="metricValue" id="metricMode">‚Äî</span>
        </div>
        <div class="metricCard">
          <span class="metricLabel">Average headway</span>
          <span class="metricValue" id="metricAverage">‚Äî</span>
        </div>
      </div>
      <div class="metricSub" id="tierDetails"></div>
      <div class="gapList" id="gapList"></div>
      <div class="departuresSection">
        <h4>Departures &amp; Gaps</h4>
        <div class="gapTables" id="gapTables"></div>
      </div>
      <table class="modalBuckets" id="bucketTable">
        <thead><tr><th>Bucket</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const fileEl = document.getElementById('gtfs');
  const btn = document.getElementById('go');
  const exportBtn = document.getElementById('export');
  const fileNameEl = document.getElementById('fileName');
  const mergeEl = document.getElementById('merge');
  const searchEl = document.getElementById('search');
  const kanbanEl = document.getElementById('kanban');
  const tableBody = document.getElementById('tableBody');
  const modalEl = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalSummary = document.getElementById('modalSummary');
  const metricMedian = document.getElementById('metricMedian');
  const metricMode = document.getElementById('metricMode');
  const metricAverage = document.getElementById('metricAverage');
  const tierDetails = document.getElementById('tierDetails');
  const gapList = document.getElementById('gapList');
  const gapTables = document.getElementById('gapTables');
  const bucketTable = document.getElementById('bucketTable').querySelector('tbody');
  const modalClose = document.getElementById('closeModal');
  const banner = document.getElementById('banner');
  const bannerEmpty = document.getElementById('bannerEmpty');
  const bannerPills = document.getElementById('bannerPills');
  const startEl = document.getElementById('start');
  const endEl = document.getElementById('end');
  const dayButtons = Array.from(document.querySelectorAll('.seg button'));
  const themeButtons = Array.from(document.querySelectorAll('[data-theme-choice]'));

  const TIER_RULES = [10,15,20,30,60];
  const TIER_LABELS = {
    10:'‚â§10',
    15:'‚â§15',
    20:'‚â§20',
    30:'‚â§30',
    60:'‚â§60',
    999:'>60'
  };
  const TIER_TIP = 'Strict +2 min grace; up to 2 events beyond T but no more than +2 each.';

  let RAW_ROWS = [];
  let DISPLAY_ROWS = [];
  let SELECTED_DAY = 'weekday';
  let HAS_RESULTS = false;

  const directionLabel = (dir, merge) => merge ? '‚Äì' : (dir === '0' ? 'Outbound' : dir === '1' ? 'Inbound' : dir);

  function updateThemeButtons(active){
    themeButtons.forEach(btn => {
      const match = btn.dataset.themeChoice === active;
      btn.classList.toggle('active', match);
    });
    document.body.setAttribute('data-theme', active);
    localStorage.setItem('gtfs-theme', active);
  }

  themeButtons.forEach(btn => {
    btn.addEventListener('click', () => updateThemeButtons(btn.dataset.themeChoice));
  });

  const savedTheme = localStorage.getItem('gtfs-theme') || 'dark';
  updateThemeButtons(savedTheme);

  function formatMinutes(mins){
    const h = Math.floor(mins/60) % 24;
    const m = mins % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  function bucketCounts(list){
    const buckets = {
      '<=10':0,
      '11-15':0,
      '16-20':0,
      '21-30':0,
      '31-60':0,
      '>60':0
    };
    list.forEach(v => {
      if(v <= 10) buckets['<=10']++;
      else if(v <= 15) buckets['11-15']++;
      else if(v <= 20) buckets['16-20']++;
      else if(v <= 30) buckets['21-30']++;
      else if(v <= 60) buckets['31-60']++;
      else buckets['>60']++;
    });
    return buckets;
  }

  function median(list){
    if(!list.length) return 0;
    const mid = Math.floor(list.length/2);
    const sorted = [...list].sort((a,b)=>a-b);
    return list.length % 2 ? sorted[mid] : Math.round((sorted[mid-1]+sorted[mid])/2);
  }

  function mode(list){
    if(!list.length) return 0;
    const counts = new Map();
    for(const v of list){
      counts.set(v,(counts.get(v)||0)+1);
    }
    let best = list[0];
    let bestCount = 0;
    for(const [value,count] of counts.entries()){
      if(count>bestCount || (count===bestCount && value<best)){
        best=value;
        bestCount=count;
      }
    }
    return best;
  }

  function average(list){
    if(!list.length) return 0;
    return Math.round(list.reduce((a,b)=>a+b,0)/list.length);
  }

  function leastWorstTier(headways){
    if(!headways.length) return 999;
    const sorted = [...headways].sort((a,b)=>a-b);
    for(const tier of TIER_RULES){
      let graceUsed = 0;
      let ok = true;
      for(const h of sorted){
        if(h <= tier) continue;
        if(h > tier + 2){ ok = false; break; }
        graceUsed++;
        if(graceUsed>2){ ok=false; break; }
      }
      if(ok) return tier;
    }
    return 999;
  }

  function parseTime(str){
    const [h,m] = str.split(':').map(Number);
    return h*60 + m;
  }

  function parseGtfsTime(str){
    const [hh='0',mm='0',ss='0'] = str.split(':');
    return Number(hh)*60 + Number(mm) + Math.floor(Number(ss)/60);
  }

  function toggleAnalyzeState(){
    const hasFile = fileEl.files && fileEl.files.length>0;
    btn.disabled = !hasFile;
    if(hasFile){
      fileNameEl.textContent = fileEl.files[0].name;
    }else{
      fileNameEl.textContent = 'No file selected';
    }
  }

  fileEl.addEventListener('change', () => {
    toggleAnalyzeState();
  });

  toggleAnalyzeState();

  function inclusiveFilter(times, start, end){
    return times.filter(t => t >= start && t <= end);
  }

  function dedupeSorted(times){
    const result = [];
    let last = null;
    for(const t of times){
      if(t !== last){
        result.push(t);
        last = t;
      }
    }
    return result;
  }

  function computeHeadways(times){
    const hw = [];
    for(let i=1;i<times.length;i++){
      hw.push(times[i]-times[i-1]);
    }
    return hw;
  }

  function groupGaps(headways){
    const counts = new Map();
    headways.forEach(hw => {
      counts.set(hw,(counts.get(hw)||0)+1);
    });
    return Array.from(counts.entries()).sort((a,b)=>b[0]-a[0]).map(([gap,count])=>({gap,count}));
  }

  async function analyze(){
    if(!fileEl.files || !fileEl.files.length) return;
    const file = fileEl.files[0];
    HAS_RESULTS = false;
    RAW_ROWS = [];
    DISPLAY_ROWS = [];
    render();
    const zip = await JSZip.loadAsync(file);
    const files = {};
    for(const path of Object.keys(zip.files)){
      files[path.toLowerCase()] = path;
    }
    const required = ['routes.txt','trips.txt','stop_times.txt','calendar.txt'];
    for(const key of required){
      if(!files[key]){
        alert(`Missing ${key}`);
        return;
      }
    }

    const [routesCsv,tripsCsv,stopTimesCsv,calendarCsv] = await Promise.all([
      zip.file(files['routes.txt']).async('string'),
      zip.file(files['trips.txt']).async('string'),
      zip.file(files['stop_times.txt']).async('string'),
      zip.file(files['calendar.txt']).async('string')
    ]);

    const routes = Papa.parse(routesCsv,{header:true,skipEmptyLines:true}).data;
    const trips = Papa.parse(tripsCsv,{header:true,skipEmptyLines:true}).data;
    const stopTimes = Papa.parse(stopTimesCsv,{header:true,skipEmptyLines:true}).data;
    const calendar = Papa.parse(calendarCsv,{header:true,skipEmptyLines:true}).data;

    const routeNames = new Map(routes.map(r => [r.route_id, r.route_short_name || r.route_long_name || r.route_id]));
    const dayService = {
      weekday: new Set(calendar.filter(c => c.monday==='1' || c.tuesday==='1' || c.wednesday==='1' || c.thursday==='1' || c.friday==='1').map(c => c.service_id)),
      saturday: new Set(calendar.filter(c => c.saturday==='1').map(c => c.service_id)),
      sunday: new Set(calendar.filter(c => c.sunday==='1').map(c => c.service_id))
    };

    const startM = parseTime(startEl.value || '00:00');
    const endM = parseTime(endEl.value || '23:59');

    const byRouteDayDir = new Map();

    const tripDepartures = new Map();
    for(const st of stopTimes){
      if(!st.trip_id || !st.departure_time) continue;
      const dep = parseGtfsTime(st.departure_time);
      if(!tripDepartures.has(st.trip_id) || dep < tripDepartures.get(st.trip_id)){
        tripDepartures.set(st.trip_id, dep);
      }
    }

    for(const trip of trips){
      if(!trip.trip_id || !trip.route_id) continue;
      const dayKeys = [];
      if(dayService.weekday.has(trip.service_id)) dayKeys.push('weekday');
      if(dayService.saturday.has(trip.service_id)) dayKeys.push('saturday');
      if(dayService.sunday.has(trip.service_id)) dayKeys.push('sunday');
      if(dayKeys.length===0) continue;
      const departure = tripDepartures.get(trip.trip_id);
      if(departure == null) continue;
      if(departure < startM || departure > endM) continue;
      const routeName = routeNames.get(trip.route_id) || trip.route_id;
      const direction = (trip.direction_id == null ? '0' : String(trip.direction_id));
      for(const day of dayKeys){
        const key = `${routeName}::${day}`;
        if(!byRouteDayDir.has(key)){
          byRouteDayDir.set(key,{
            route:routeName,
            day,
            timesByDir:{'0':[], '1':[]}
          });
        }
        byRouteDayDir.get(key).timesByDir[direction] = byRouteDayDir.get(key).timesByDir[direction] || [];
        byRouteDayDir.get(key).timesByDir[direction].push(departure);
      }
    }

    RAW_ROWS = [];
    for(const {route,day,timesByDir} of byRouteDayDir.values()){
      for(const dir of Object.keys(timesByDir)){
        const sortedTimes = timesByDir[dir].sort((a,b)=>a-b);
        const filteredTimes = inclusiveFilter(sortedTimes,startM,endM);
        if(!filteredTimes.length) continue;
        const deduped = dedupeSorted(filteredTimes);
        const headways = computeHeadways(deduped);
        const medianHw = median(headways);
        const modeHw = mode(headways);
        const avgHw = average(headways);
        const tier = leastWorstTier(headways);
        RAW_ROWS.push({
          route,
          day,
          dir,
          tier,
          headways,
          median: medianHw,
          mode: modeHw,
          avg: avgHw,
          times: deduped,
          timesByDir: {[dir]: deduped},
          departures: deduped.length,
          buckets: bucketCounts(headways)
        });
      }
    }

    HAS_RESULTS = true;
    render();
  }

  function cloneRow(row){
    return JSON.parse(JSON.stringify(row));
  }

  function mergeRows(rows){
    const merged = new Map();
    for(const row of rows){
      const key = `${row.route}::${row.day}`;
      if(!merged.has(key)){
        merged.set(key,{
          route:row.route,
          day:row.day,
          dir:'‚Äì',
          timesByDir:{'0':[], '1':[]},
          headways:[],
          tiers:[],
          departures:0,
          buckets:{'<=10':0,'11-15':0,'16-20':0,'21-30':0,'31-60':0,'>60':0}
        });
      }
      const entry = merged.get(key);
      entry.timesByDir[row.dir] = row.times;
      entry.headways = entry.headways.concat(row.headways);
      entry.tiers.push(row.tier);
      entry.departures += row.departures || 0;
      for(const bucket in row.buckets){
        entry.buckets[bucket] += row.buckets[bucket];
      }
    }
    const result = [];
    for(const entry of merged.values()){
      const headways = entry.headways.sort((a,b)=>a-b);
      const tier = leastWorstTier(headways);
      const med = median(headways);
      const mod = mode(headways);
      const avg = average(headways);
      result.push({
        route:entry.route,
        day:entry.day,
        dir:'‚Äì',
        tier,
        headways,
        median:med,
        mode:mod,
        avg,
        timesByDir:entry.timesByDir,
        times:[],
        departures: entry.departures,
        buckets:entry.buckets
      });
    }
    return result;
  }

  function formatTier(tier){
    if(tier === 999) return '>60';
    return `‚â§${tier}`;
  }

  function renderKanban(rows){
    const columns = {
      '‚â§10':[],
      '‚â§15':[],
      '‚â§20':[],
      '‚â§30':[],
      '‚â§60':[],
      '>60':[]
    };
    for(const row of rows){
      const tierKey = row.tier === 999 ? '>60' : `‚â§${row.tier}`;
      columns[tierKey].push(row);
    }
    const order = ['‚â§10','‚â§15','‚â§20','‚â§30','‚â§60','>60'];
    kanbanEl.innerHTML = order.map(key => {
      const list = columns[key];
      const cards = list.map(row => `
        <div class="card" data-route="${encodeURIComponent(row.route)}" data-day="${row.day}" data-dir="${row.dir}">
          <div class="routeLine">
            <span>${row.route}</span>
            <span class="dir">${directionLabel(row.dir, mergeEl.checked)}</span>
          </div>
          <div class="day">${row.day}</div>
          <div class="stat">Median ${row.median ? row.median+' min' : '‚Äî'}</div>
        </div>
      `).join('');
      return `
        <div class="col">
          <h3>${key}</h3>
          <div class="cards">${cards || '<span class="muted">None</span>'}</div>
        </div>
      `;
    }).join('');
  }

  function renderTable(rows){
    tableBody.innerHTML = rows.map(row => {
      const tierClass = row.tier === 999 ? 'tBig' : `t${row.tier}`;
      const tierLabel = row.tier === 999 ? '>60' : `‚â§${row.tier}`;
      return `
        <tr data-route="${encodeURIComponent(row.route)}" data-day="${row.day}" data-dir="${row.dir}">
          <td class="route">${row.route}</td>
          <td>${directionLabel(row.dir, mergeEl.checked)}</td>
          <td>${row.day}</td>
          <td>${row.departures || (row.headways.length + 1)}</td>
          <td>${row.median || '‚Äî'}</td>
          <td>${row.mode || '‚Äî'}</td>
          <td>${row.avg || '‚Äî'}</td>
          <td><span class="tier ${tierClass}" title="${TIER_TIP}">${tierLabel}</span></td>
        </tr>
      `;
    }).join('');
  }

  function renderBanner(rows){
    const frequent = rows.filter(row => row.day === 'weekday' && (row.tier === 10 || row.tier === 15));
    bannerPills.innerHTML = '';
    if(!HAS_RESULTS){
      banner.style.display = 'none';
      return;
    }
    banner.style.display = 'block';
    if(!frequent.length){
      bannerEmpty.style.display = 'block';
      bannerEmpty.textContent = 'No ‚â§15 min routes found';
      return;
    }
    bannerEmpty.style.display = 'none';
    bannerEmpty.textContent = '';
    frequent.sort((a,b)=>a.route.localeCompare(b.route));
    for(const row of frequent){
      const pill = document.createElement('button');
      pill.type = 'button';
      pill.textContent = row.route;
      pill.addEventListener('click', () => {
        let changed = false;
        if(SELECTED_DAY !== 'weekday'){
          SELECTED_DAY = 'weekday';
          dayButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.day === 'weekday'));
          changed = true;
        }
        if(searchEl.value){
          searchEl.value = '';
          changed = true;
        }
        if(changed) render();
        const target = tableBody.querySelector(`tr[data-route="${encodeURIComponent(row.route)}"][data-day="${row.day}"]`);
        if(target){
          target.scrollIntoView({behavior:'smooth',block:'center'});
          target.classList.add('highlight');
          setTimeout(()=>target.classList.remove('highlight'),1400);
        }
      });
      bannerPills.appendChild(pill);
    }
  }

  function applySearch(rows){
    const term = searchEl.value.trim().toLowerCase();
    if(!term) return rows;
    return rows.filter(row => row.route.toLowerCase().includes(term));
  }

  function render(){
    const merge = mergeEl.checked;
    const baseRows = RAW_ROWS.filter(r => r.day === SELECTED_DAY);
    const rows = merge ? mergeRows(baseRows) : baseRows.map(cloneRow);
    rows.sort((a,b)=>{
      if(a.tier !== b.tier) return (a.tier===999?Infinity:a.tier) - (b.tier===999?Infinity:b.tier);
      if(a.route !== b.route) return a.route.localeCompare(b.route);
      if(a.day !== b.day) return a.day.localeCompare(b.day);
      if(a.dir !== b.dir) return a.dir.localeCompare(b.dir);
      return 0;
    });
    DISPLAY_ROWS = rows;
    const filtered = applySearch(rows);
    renderKanban(filtered);
    renderTable(filtered);
    const weekdayMerged = mergeRows(RAW_ROWS.filter(r => r.day === 'weekday'));
    renderBanner(weekdayMerged);
    exportBtn.disabled = !rows.length;
  }

  function showModal(route, day, dir){
    const merge = mergeEl.checked;
    let row;
    if(merge){
      row = DISPLAY_ROWS.find(r => r.route === route && r.day === day);
    }else{
      row = DISPLAY_ROWS.find(r => r.route === route && r.day === day && r.dir === dir);
    }
    if(!row) return;

    modalTitle.textContent = `${row.route} ¬∑ ${day}`;
    modalSummary.textContent = merge ? 'Merged directions' : directionLabel(row.dir,false);
    metricMedian.textContent = row.median ? `${row.median} min` : '‚Äî';
    metricMode.textContent = row.mode ? `${row.mode} min` : '‚Äî';
    metricAverage.textContent = row.avg ? `${row.avg} min` : '‚Äî';
    tierDetails.textContent = `Tier ${row.tier===999?'>60':`‚â§${row.tier}`} ¬∑ ${row.headways.length} headways analysed.`;

    gapList.innerHTML = '';
    const groups = groupGaps(row.headways);
    groups.slice(0,10).forEach(item => {
      const div = document.createElement('div');
      div.className = 'chip';
      div.textContent = `${item.gap} (√ó${item.count})`;
      gapList.appendChild(div);
    });

    bucketTable.innerHTML = '';
    for(const [label,count] of Object.entries(row.buckets)){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${label}</td><td>${count}</td>`;
      bucketTable.appendChild(tr);
    }

    gapTables.innerHTML = '';
    const dirKeys = ['0','1'];
    const classes = merge ? 'gapTables stack' : 'gapTables twoCols';
    gapTables.className = classes;

    const related = RAW_ROWS.filter(r => r.route === row.route && r.day === row.day);
    const dirLookup = {'0':null,'1':null};
    related.forEach(r => { dirLookup[r.dir] = r; });

    dirKeys.forEach(key => {
      const data = dirLookup[key];
      if(!data || !data.times || !data.times.length) return;
      const label = key === '0' ? 'Outbound' : 'Inbound';
      const deduped = dedupeSorted([...data.times].sort((a,b)=>a-b));
      const gaps = computeHeadways(deduped);
      const wrap = document.createElement('div');
      wrap.className = 'gapTableWrap';
      wrap.innerHTML = `<h5>${label}</h5>`;
      const scroll = document.createElement('div');
      scroll.className = 'gapTableScroll';
      const table = document.createElement('table');
      table.className = 'gapTable';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>#</th><th>Time</th><th>Gap since previous</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      deduped.forEach((time,idx) => {
        const tr = document.createElement('tr');
        const gap = idx===0 ? null : gaps[idx-1];
        let badge = '‚Äî';
        if(gap!=null){
          const span = document.createElement('span');
          span.className = 'gapBadge';
          const threshold = data.tier === 999 ? null : data.tier;
          if(threshold != null){
            if(gap>threshold && gap<=threshold+2){
              span.classList.add('gapWarn');
            }else if(gap>threshold+2){
              span.classList.add('gapHigh');
            }
          }
          span.textContent = gap;
          badge = span.outerHTML;
        }
        tr.innerHTML = `<td class="numCol">${idx+1}</td><td>${formatMinutes(time)}</td><td>${badge}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      scroll.appendChild(table);
      wrap.appendChild(scroll);
      gapTables.appendChild(wrap);
    });

    modalEl.style.display = 'flex';
    modalEl.setAttribute('aria-hidden','false');
  }

  function hideModal(){
    modalEl.style.display = 'none';
    modalEl.setAttribute('aria-hidden','true');
  }

  kanbanEl.addEventListener('click', e => {
    const card = e.target.closest('.card');
    if(!card) return;
    const route = decodeURIComponent(card.dataset.route);
    const day = card.dataset.day;
    const dir = card.dataset.dir;
    showModal(route, day, dir);
  });

  tableBody.addEventListener('click', e => {
    const row = e.target.closest('tr');
    if(!row) return;
    const route = decodeURIComponent(row.dataset.route);
    const day = row.dataset.day;
    const dir = row.dataset.dir;
    showModal(route, day, dir);
  });

  modalClose.addEventListener('click', hideModal);
  modalEl.addEventListener('click', e => { if(e.target === modalEl) hideModal(); });
  document.addEventListener('keydown', e => { if(e.key === 'Escape') hideModal(); });

  mergeEl.addEventListener('change', render);
  searchEl.addEventListener('input', render);
  dayButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      dayButtons.forEach(b => b.classList.toggle('active', b === btn));
      SELECTED_DAY = btn.dataset.day;
      render();
    });
  });

  exportBtn.addEventListener('click', () => {
    if(!DISPLAY_ROWS.length) return;
    const rows = [['Route','Direction','Day','Trips','Median','Mode','Average','Tier']];
    DISPLAY_ROWS.forEach(row => {
        rows.push([
          row.route,
          directionLabel(row.dir, mergeEl.checked),
          row.day,
          row.departures || (row.headways.length + 1),
          row.median,
          row.mode,
          row.avg,
          row.tier === 999 ? '>60' : `‚â§${row.tier}`
        ]);
    });
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'least-worst.csv';
    link.click();
  });

  btn.addEventListener('click', analyze);
</script>
</body>
</html>
